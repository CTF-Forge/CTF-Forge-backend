# CTFLab

èª°ã‚‚ãŒCTFã®å•é¡Œã‚’ä½œæˆã—ã€å…¬é–‹ã§ãã‚‹ã‚¢ãƒ—ãƒªã€‚
webã¨desktopã§å…¬é–‹ã™ã‚‹ã€‚

æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ             | æ¨å¥¨æŠ€è¡“                          | ä¸»è¦ãªå½¹å‰²ãƒ»é¸å®šç†ç”±                                                                 |
|----------------------------|-----------------------------------|----------------------------------------------------------------------------------------|
| ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨€èª           | Go                                | ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦ä»¶ã€‚é«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ä¸¦è¡Œå‡¦ç†æ€§èƒ½ã€‚                                     |
| ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | Gin                               | é«˜æ€§èƒ½ãªHTTPãƒ«ãƒ¼ã‚¿ãƒ¼ã€è±Šå¯ŒãªãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã€åºƒç¯„ãªã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã€‚                        |
| ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | Wails                             | WebæŠ€è¡“ã‚’ç”¨ã„ãŸUIé–‹ç™ºã€Goã¨ã®ç›´æ¥é€£æºã€è»½é‡ãªãƒã‚¤ãƒŠãƒªç”Ÿæˆã€‚                           |
| ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | Svelte                            | ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ™ãƒ¼ã‚¹ã«ã‚ˆã‚‹é«˜é€Ÿãªãƒ©ãƒ³ã‚¿ã‚¤ãƒ æ€§èƒ½ã¨è»½é‡ãªãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã€‚                     |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹               | PostgreSQL                        | å …ç‰¢æ€§ã€è±Šå¯Œãªæ©Ÿèƒ½ã‚»ãƒƒãƒˆï¼ˆJSONB, å…¨æ–‡æ¤œç´¢ï¼‰ã€é«˜ã„ä¿¡é ¼æ€§ã€‚                            |
| ORM/ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹         | GORM                              | é–‹ç™ºåŠ¹ç‡ã®å‘ä¸Šã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã€è±Šå¯Œãªé–¢é€£ä»˜ã‘æ©Ÿèƒ½ã€‚                             |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ | golang-migrate / Atlas            | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã•ã‚ŒãŸå®‰å…¨ãªã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ã‚’å®Ÿç¾ã€‚                                        |
| APIèªè¨¼                    | JWT (Access + Refresh Tokens)     | ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹èªè¨¼ã€ã‚»ã‚­ãƒ¥ã‚¢ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã€‚                                          |
| ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¤œè¨¼            | go-playground/validator           | æ§‹é€ ä½“ã‚¿ã‚°ãƒ™ãƒ¼ã‚¹ã®å®£è¨€çš„ãªå…¥åŠ›å€¤æ¤œè¨¼ã€‚                                                |
| è¨­å®šç®¡ç†                  | YAML (Viper)                      | ç’°å¢ƒã”ã¨ã®è¨­å®šã‚’æŸ”è»Ÿã«ç®¡ç†ã€‚                                                           |
| ãƒ†ã‚¹ãƒˆï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰     | httptest                          | Goæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã‚ˆã‚‹HTTPãƒãƒ³ãƒ‰ãƒ©ã®å˜ä½“ãƒ†ã‚¹ãƒˆã€‚                                      |
| ãƒ†ã‚¹ãƒˆï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰   | Vitest + Svelte Testing Library   | Viteãƒã‚¤ãƒ†ã‚£ãƒ–ã®é«˜é€Ÿãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆã€‚                                          |
| ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ             | Docker                            | ç’°å¢ƒã®å†ç¾æ€§ã¨ãƒãƒ¼ã‚¿ãƒ“ãƒªãƒ†ã‚£ã‚’ç¢ºä¿ã€‚                                                  |

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
```text
.
â”œâ”€â”€ cmd
â”‚   â””â”€â”€ server
â”‚       â””â”€â”€ main.go         # ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
â”œâ”€â”€ config
â”‚   â””â”€â”€ config.go           # è¨­å®šï¼ˆç’°å¢ƒå¤‰æ•°ãƒ»DBæ¥ç¶šãªã©ï¼‰
â”œâ”€â”€ internal
â”‚   â”œâ”€â”€ models
â”‚   â”‚   â””â”€â”€ user.go         # ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ï¼ˆUserç­‰ï¼‰
â”‚   â”œâ”€â”€ repository
â”‚   â”‚   â””â”€â”€ user_repo.go    # æ°¸ç¶šåŒ–å±¤ï¼ˆDBï¼‰
â”‚   â”œâ”€â”€ service
â”‚   â”‚   â”œâ”€â”€ auth_service.go # ãƒ­ãƒ¼ã‚«ãƒ«èªè¨¼
â”‚   â”‚   â””â”€â”€ oauth_service.go# OAuthèªè¨¼ï¼ˆgothã‚’ä½¿ã†ï¼‰
â”‚   â”œâ”€â”€ handler
â”‚   â”‚   â”œâ”€â”€ auth_handler.go # /auth/login, register
â”‚   â”‚   â””â”€â”€ oauth_handler.go# /auth/github, /auth/google
â”‚   â””â”€â”€ router
â”‚       â””â”€â”€ router.go       # Ginãƒ«ãƒ¼ã‚¿ãƒ¼å®šç¾©
â”œâ”€â”€ pkg
â”‚   â””â”€â”€ token
â”‚       â””â”€â”€ jwt.go          # JWTé–¢é€£ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”œâ”€â”€ oauth
â”‚   â””â”€â”€ init.go             # goth.UseProviders ãªã©åˆæœŸåŒ–
â”œâ”€â”€ docs
â”‚   â””â”€â”€ swagger...          # Swagç”¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â”œâ”€â”€ frontend
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ main.go                 # redirect to cmd/server/main.go
â””â”€â”€ migrations              # DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
```

é–‹ç™ºé †ç•ª
```
Step 1. æ©Ÿèƒ½ä¸€è¦§ã¨ç”»é¢æ§‹æˆ
Step 2. ERå›³ / GORMãƒ¢ãƒ‡ãƒ«ä½œæˆ
Step 3. Ginã®APIè¨­è¨ˆï¼ˆrouter + handlerï¼‰
Step 4. UIãƒ¢ãƒƒã‚¯ï¼ˆSvelteKitã§ä»®çµ„ã¿ï¼‰
Step 5. APIé€£æº
Step 6. Wailsçµ±åˆ
```

# Step 1. æ©Ÿèƒ½ä¸€è¦§ã¨ç”»é¢æ§‹æˆ

## MVP
- èªè¨¼æ©Ÿèƒ½
    - Github / Microsoft ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ (OAuth2)
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
    - è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é–²è¦§(è¡¨ç¤ºåã€å•é¡Œæ•°ãªã©)
    - ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
- å•é¡Œä½œæˆãƒ»ç®¡ç†
    - å•é¡Œæ–°è¦ä½œæˆ(title,description,ã‚«ãƒ†ã‚´ãƒª,flag,æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«)
    - å•é¡Œã®ä¿å­˜ãƒ»ç·¨é›†ãƒ»å‰Šé™¤(è‡ªåˆ†ã®å•é¡Œã®ã¿)
    - å•é¡Œã«Dockerãƒ™ãƒ¼ã‚¹ã®ç’°å¢ƒã‚’æ·»ä»˜(ä¾‹:pwnç”¨ã‚³ãƒ³ãƒ†ãƒŠ)
- å•é¡Œå…¬é–‹ãƒ»å…±æœ‰
    - æ¼”é¡Œä¸€è¦§ãƒšãƒ¼ã‚¸(è‡ªä½œ&ä»–äººã®å•é¡ŒãŒè¦‹ãˆã‚‹)
    - å•é¡Œè©³ç´°ãƒšãƒ¼ã‚¸(description,æ·»ä»˜,flagæå‡ºç”¨ãƒ•ã‚©ãƒ¼ãƒ )
    - å…¬é–‹ãƒ»éå…¬é–‹ãƒ•ãƒ©ã‚°
- Flagæå‡ºãƒ»åˆ¤å®š
    - è§£ç­”ãƒ•ã‚©ãƒ¼ãƒ (flagå…¥åŠ›â†’è‡ªå‹•åˆ¤å®š)
    - è§£ç­”å±¥æ­´(è‡ªåˆ†ãŒã©ã‚Œã‚’è§£ã„ãŸã‹)
- ç®¡ç†è€…ãƒ»é‹ç”¨è¦–ç‚¹ã®æœ€ä½é™æ©Ÿèƒ½
    - ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤(ä¾‹: `problem.user.ctflab.dev`)
    - å•é¡Œã”ã¨ã«ç‹¬ç«‹ã—ãŸDockerç’°å¢ƒã‚’ç«‹ã¦ã‚‹
    - é‹ç”¨è² è·ã‚’æ¸›ã‚‰ã™å•é¡Œã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—(ã„ã„å®šæ™‚é–“å¾Œè‡ªå‹•åœæ­¢)

## ç”»é¢æ§‹æˆ(MVP)

```
[ãƒ›ãƒ¼ãƒ ] (/)
 â”œâ”€â–¶ [ãƒ­ã‚°ã‚¤ãƒ³] (/login)
 â”œâ”€â–¶ [å•é¡Œä¸€è¦§] (/challenges)
 â”‚     â””â”€â–¶ [å•é¡Œè©³ç´°] (/challenges/:id)
 â”‚           â””â”€â–¶ [Flagæå‡ºçµæœãƒ¢ãƒ¼ãƒ€ãƒ«]
 â”œâ”€â–¶ [å•é¡Œä½œæˆ] (/challenges/new)  â†ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿
 â”œâ”€â–¶ [ãƒã‚¤ãƒšãƒ¼ã‚¸] (/me)
 â”‚     â”œâ”€â–¶ [è‡ªåˆ†ã®å•é¡Œä¸€è¦§] (/me/challenges)
 â”‚     â”œâ”€â–¶ [è§£ç­”å±¥æ­´] (/me/submissions)
 â””â”€â–¶ [ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ]
```

```mermaid
graph TD
    A[ãƒ›ãƒ¼ãƒ  /] --> B[ãƒ­ã‚°ã‚¤ãƒ³ /login]
    A --> C[å•é¡Œä¸€è¦§ /challenges]
    C --> C1[å•é¡Œè©³ç´° /challenges/:id]
    C1 --> C2[Flagæå‡ºçµæœãƒ¢ãƒ¼ãƒ€ãƒ«]

    A --> D[ãƒã‚¤ãƒšãƒ¼ã‚¸ /me]
    D --> D1[è‡ªåˆ†ã®å•é¡Œä¸€è¦§ /me/challenges]
    D --> D2[æå‡ºå±¥æ­´ /me/submissions]

    A --> E[å•é¡Œä½œæˆ /challenges/new]
    A --> F[ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ]

    B --> A
    F --> A
```
![ç”»é¢æ§‹æˆ](./ç”»é¢æ§‹æˆ.png)

# Step 2. ERå›³ / GORMãƒ¢ãƒ‡ãƒ«

## ğŸ“„ usersï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼‰

| Column         | Type         | Description                        |
|----------------|--------------|------------------------------------|
| id             | SERIAL PK    | ãƒ¦ãƒ¼ã‚¶ãƒ¼ID                         |
| username       | TEXT UNIQUE  | è¡¨ç¤ºåãƒ»ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ç”¨            |
| email          | TEXT UNIQUE  | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆèªè¨¼ç”¨ï¼‰          |
| password_hash  | TEXT         | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥               |
| created_at     | TIMESTAMP    | ç™»éŒ²æ—¥æ™‚                           |

---

## ğŸ“„ challengesï¼ˆå•é¡Œæƒ…å ±ï¼‰

| Column         | Type         | Description                        |
|----------------|--------------|------------------------------------|
| id             | SERIAL PK    | å•é¡ŒID                             |
| user_id        | INTEGER FK   | ä½œæˆè€…ãƒ¦ãƒ¼ã‚¶ãƒ¼                     |
| title          | TEXT         | å•é¡Œåï¼ˆä¾‹ï¼šfugaï¼‰                |
| description    | TEXT         | å•é¡Œæ–‡ï¼ˆMarkdownç­‰ï¼‰              |
| category_id    | INTEGER FK   | ã‚«ãƒ†ã‚´ãƒªï¼ˆpwn/web/revãªã©ï¼‰       |
| flag           | TEXT         | ãƒ•ãƒ©ã‚°ï¼ˆãƒãƒƒã‚·ãƒ¥ or ãƒ—ãƒ¬ãƒ¼ãƒ³ï¼‰    |
| is_public      | BOOLEAN      | å…¬é–‹ãƒ•ãƒ©ã‚°ï¼ˆtrueã§ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºï¼‰|
| score          | INTEGER      | åˆæœŸã‚¹ã‚³ã‚¢                         |
| created_at     | TIMESTAMP    | ä½œæˆæ—¥                             |

---

## ğŸ“„ challenge_categoriesï¼ˆå•é¡Œã‚«ãƒ†ã‚´ãƒªï¼‰

| Column         | Type         | Description                        |
|----------------|--------------|------------------------------------|
| id             | SERIAL PK    | ã‚«ãƒ†ã‚´ãƒªID                         |
| name           | TEXT         | pwn, web, miscãªã©                 |

---

## ğŸ“„ challenge_filesï¼ˆæ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ï¼‰

| Column         | Type         | Description                        |
|----------------|--------------|------------------------------------|
| id             | SERIAL PK    | ãƒ•ã‚¡ã‚¤ãƒ«ID                         |
| challenge_id   | INTEGER FK   | å¯¾å¿œã™ã‚‹å•é¡ŒID                     |
| filename       | TEXT         | å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«å                     |
| filepath       | TEXT         | ã‚µãƒ¼ãƒãƒ¼å†…ä¿å­˜ãƒ‘ã‚¹                 |
| mimetype       | TEXT         | application/zip ã®ã¿å¯¾å¿œ           |
| size           | INTEGER      | ã‚µã‚¤ã‚ºï¼ˆãƒã‚¤ãƒˆï¼‰                  |
| uploaded_at    | TIMESTAMP    | ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥æ™‚                   |

---

## ğŸ“„ docker_challengesï¼ˆDockerç®¡ç†ãŒå¿…è¦ãªå•é¡Œï¼‰

| Column         | Type         | Description                        |
|----------------|--------------|------------------------------------|
| id             | SERIAL PK    | Dockeræƒ…å ±ID                       |
| challenge_id   | INTEGER FK   | å¯¾å¿œã™ã‚‹ challenge                 |
| image_tag      | TEXT         | ä¾‹ï¼šctflab/bob-hoge:latest         |
| exposed_port   | INTEGER      | èµ·å‹•æ™‚ã«å…¬é–‹ã™ã‚‹ãƒãƒ¼ãƒˆ            |
| entrypoint     | TEXT         | å®Ÿè¡Œã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ               |
| created_at     | TIMESTAMP    | ä½œæˆæ—¥æ™‚                           |

---

## ğŸ“„ submissionsï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æå‡ºå±¥æ­´ï¼‰

| Column         | Type         | Description                        |
|----------------|--------------|------------------------------------|
| id             | SERIAL PK    | æå‡ºID                             |
| user_id        | INTEGER FK   | æå‡ºè€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ID                   |
| challenge_id   | INTEGER FK   | å¯¾è±¡ã® challenge                   |
| submitted_at   | TIMESTAMP    | æå‡ºæ—¥æ™‚                           |
| flag           | TEXT         | æå‡ºã•ã‚ŒãŸ flag                    |
| is_correct     | BOOLEAN      | æ­£è§£ã‹ã©ã†ã‹                       |

![ERå›³](./DB_ERå›³.png)